<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Air Quality</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9/dist/leaflet.css"/>
  <style>
    body{font-family:Arial;margin:0}#map{height:500px}#box{padding:10px}
    .air-card{width:260px;background:#fff6d6;border:1px solid #f9d34a;border-radius:8px;padding:12px;margin:10px 0;font-size:14px;box-shadow:0 2px 4px rgba(0,0,0,.15)}
    .air-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .aqi-circle{width:46px;height:46px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#fff;font-size:18px}
    .poll-table{width:100%;font-size:13px;border-collapse:collapse;margin:6px 0}.poll-table td{padding:3px 0}.poll-table td:nth-child(2){text-align:right;font-weight:bold}
    .health-row{display:flex;align-items:center;margin-top:8px;font-size:12px;background:#ffeaa7;border-radius:4px;padding:6px}.health-row #healthIcon{margin-right:6px;font-size:16px}
    .mini-forecast{display:flex;justify-content:space-between;margin-top:10px;border-top:1px solid #f9d34a;padding-top:8px}.day{text-align:center;font-size:12px}.day b{display:block;font-size:16px;margin-top:2px}.hidden{display:none}
  </style>
</head>
<body>
<div id="box">
  <h2>Air Quality</h2>
  <input id="cityIn" placeholder="Type city name (e.g. Pune)" size="25"/>
  <button onclick="getAQI()">Get AQI</button>

  <!--  yellow card  -->
  <div id="airCard" class="air-card hidden">
    <div class="air-header"><span id="cardCity">-</span><span id="cardAqi" class="aqi-circle">-</span></div>
    <table class="poll-table">
      <tr><td>PM‚ÇÇ.‚ÇÖ</td><td id="cardPM25"><b>-</b> Œºg/m¬≥</td></tr>
      <tr><td>PM‚ÇÅ‚ÇÄ</td><td id="cardPM10"><b>-</b> Œºg/m¬≥</td></tr>
      <tr><td>SO‚ÇÇ</td><td id="cardSO2"><b>-</b> Œºg/m¬≥</td></tr>
      <tr><td>O‚ÇÉ</td><td id="cardO3"><b>-</b> Œºg/m¬≥</td></tr>
      <tr><td>NO‚ÇÇ</td><td id="cardNO2"><b>-</b> Œºg/m¬≥</td></tr>
      <tr><td>CO</td><td id="cardCO"><b>-</b> mg/m¬≥</td></tr>
      <tr><td>O‚ÇÇ</td><td id="cardO2"><b>-</b> Œºg/m¬≥</td></tr>
    </table>
    <div class="health-row"><div id="healthIcon">‚ö†Ô∏è</div><div id="healthText">Loading health advice‚Ä¶</div></div>
    <div class="air-row">Updated <span id="cardTime">-</span></div>
    <div class="mini-forecast">
      <div class="day"><span id="d0n">-</span><b id="d0v">-</b></div>
      <div class="day"><span id="d1n">-</span><b id="d1v">-</b></div>
      <div class="day"><span id="d2n">-</span><b id="d2v">-</b></div>
    </div>
  </div>
</div>

<div id="map"></div>
<canvas id="chart" width="800" height="250"></canvas>

<script src="https://unpkg.com/leaflet@1.9/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const OWM_KEY = '81e530b80a000a863acc4ed923f4fd33';   // ‚Üê your key

  /* ----------  map  ---------- */
  const map = L.map('map').setView([18.52, 73.86], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  /* ----------  main search  ---------- */
  async function getAQI(){
    const raw = document.getElementById('cityIn').value.trim() || 'Pune';
    const city = raw.toLowerCase().replace(/\s+/g,'');

    try{
      // 1. WAQI city search
      const r1 = await fetch(`/api/aqi/${city}`);
      const d1 = await r1.json();
      if(d1.status !== 'success') throw new Error('City not found');

      let { lat, lon, cityName, aqi, pollutants } = await extractWAQI(d1, raw);
      await showCard(cityName, aqi, pollutants);
      showMarker(lat, lon, cityName, aqi);
      const fc = await fetch(`/api/forecast/${lat}/${lon}`).then(r=>r.json());
      showForecast(fc);
    }catch(e){ alert(e.message); }
  }

  /* ----------  helpers  ---------- */
  async function extractWAQI(d, raw){
    const cityName = d.data.city.name;
    const aqi      = d.data.current.pollution.aqius;
    let p          = d.data.current.pollution;        // may be sparse
    let lat, lon;

    if(d.data.city.geo){ lat=d.data.city.geo[0]; lon=d.data.city.geo[1]; }
    else {                                          // geocode fallback
      const geo = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(raw)}&limit=1&appid=${OWM_KEY}`).then(r=>r.json());
      if(!geo.length) throw new Error('No coordinates');
      lat=geo[0].lat; lon=geo[0].lon;
    }

    // if ANY gas missing ‚Üí pull full set from OpenWeather current
    const hasAll = ['pm2_5','pm10','so2','o3','no2','co'].every(k=> p[k]!=null);
    if(!hasAll){
      const cur = await fetch(`/api/current/${lat}/${lon}`).then(r=>r.json());
      p = cur.data.pollution;          // always complete
    }
    return { lat, lon, cityName, aqi, pollutants:p };
  }

  function showCard(city, aqi, p){
    document.getElementById('cardCity').textContent = city;
    document.getElementById('cardAqi').textContent  = aqi;
    document.getElementById('cardTime').textContent = new Date().toLocaleString('en-IN',{hour:'2-digit',minute:'2-digit',month:'short',day:'numeric'});

    // pollutants  (‚Äì instead of N/A)
    document.getElementById('cardPM25').innerHTML = `<b>${p.pm2_5?.toFixed(1)||'‚Äì'}</b>`;
    document.getElementById('cardPM10').innerHTML = `<b>${p.pm10 ?.toFixed(1)||'‚Äì'}</b>`;
    document.getElementById('cardSO2').innerHTML  = `<b>${p.so2  ?.toFixed(1)||'‚Äì'}</b>`;
    document.getElementById('cardO3').innerHTML   = `<b>${p.o3   ?.toFixed(1)||'‚Äì'}</b>`;
    document.getElementById('cardNO2').innerHTML  = `<b>${p.no2  ?.toFixed(1)||'‚Äì'}</b>`;
    document.getElementById('cardCO').innerHTML   = `<b>${p.co   ?.toFixed(1)||'‚Äì'}</b>`;
    document.getElementById('cardO2').innerHTML   = `<b>${p.o2   ?.toFixed(1)||'‚Äì'}</b>`;

    const circle = document.getElementById('cardAqi');
    if(aqi>300)        circle.style.background='#7e0023';
    else if(aqi>200)   circle.style.background='#8f3f97';
    else if(aqi>150)   circle.style.background='#ff0000';
    else if(aqi>100)   circle.style.background='#ff7e00';
    else if(aqi>50)    circle.style.background='#ffff00';
    else               circle.style.background='#00e400';
    document.getElementById('airCard').classList.remove('hidden');
    setHealthAdvice(aqi, p);
  }

  function showMarker(lat, lon, city, aqi){
    map.setView([lat,lon],11);
    if(window.currentMarker) map.removeLayer(window.currentMarker);
    window.currentMarker = L.circleMarker([lat,lon],{
      color:'#fff',weight:2,fillOpacity:0.9,
      fillColor:document.getElementById('cardAqi').style.background,
      radius:16
    }).addTo(map).bindPopup(`<b>${city}</b><br>AQI: ${aqi}`).openPopup();
  }

  function showForecast(fc){
    const list = fc.list.filter((_,i)=>i%8===0).slice(0,3);
    list.forEach((o,idx)=>{
      const date = new Date(o.dt*1000);
      document.getElementById(`d${idx}n`).textContent = date.toLocaleDateString('en-IN',{weekday:'short'});
      document.getElementById(`d${idx}v`).textContent = o.components.pm2_5.toFixed(0);
    });
  }

  /* ----------  health advice  ---------- */
  function setHealthAdvice(aqi, p){
    const txt = document.getElementById('healthText');
    const icon= document.getElementById('healthIcon');
    let msg=[];
    if(aqi>300){icon.textContent='‚ò†Ô∏è'; msg.push('HAZARDOUS ‚Äì everyone may experience serious health effects. Avoid outdoor exertion.');}
    else if(aqi>200){icon.textContent='üõë'; msg.push('Very unhealthy ‚Äì sensitive groups: avoid outdoor activity. Others: limit exertion.');}
    else if(aqi>150){icon.textContent='‚ö†Ô∏è'; msg.push('Unhealthy ‚Äì sensitive groups should reduce outdoor activities.');}
    else if(aqi>100){icon.textContent='‚ö†Ô∏è'; msg.push('Unhealthy for sensitive groups ‚Äì heart/lung patients, children & older adults: limit prolonged outdoor effort.');}
    else if(aqi>50){icon.textContent='‚úÖ'; msg.push('Moderate ‚Äì acceptable for most. Very sensitive people may experience minor breathing discomfort.');}
    else{icon.textContent='üòä'; msg.push('Good ‚Äì air quality is satisfactory for most people.');}
    if(p.pm2_5>55) msg.push('PM‚ÇÇ.‚ÇÖ high ‚Äì can penetrate deep into lungs and blood; linked to heart attacks, asthma, low birth-weight.');
    if(p.pm10>154) msg.push('PM‚ÇÅ‚ÇÄ high ‚Äì irritates eyes, nose, throat; worsens asthma & bronchitis.');
    if(p.so2>185)  msg.push('SO‚ÇÇ high ‚Äì narrows airways, triggers asthma, causes coughing/wheezing.');
    if(p.no2>100)  msg.push('NO‚ÇÇ high ‚Äì inflames airways, increases respiratory infections, reduces lung growth in kids.');
    if(p.o3>140)   msg.push('Ozone high ‚Äì scorches lung tissue, causes chest pain, coughing, throat irritation.');
    if(p.co>12)    msg.push('CO high ‚Äì reduces oxygen delivery; headache, dizziness, fatigue, heart strain.');
    txt.innerHTML = msg.join('<br>‚Ä¢ ');
  }

  /* ----------  initial load  ---------- */
  getAQI();
</script>
</body>
</html>